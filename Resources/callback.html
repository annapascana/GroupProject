<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CrimsonCollab - OAuth Callback</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="./Styles/login.css" />
  </head>
  <body>
    <!-- Main Container -->
    <div class="login-container">
      <!-- Background Elements -->
      <div class="background-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
      </div>

      <!-- Callback Card -->
      <div class="login-card">
        <!-- Header -->
        <div class="login-header text-center mb-4">
          <div class="logo mb-3">
            <i class="bi bi-people-fill"></i>
          </div>
          <h1 class="brand-title">CrimsonCollab</h1>
          <p class="brand-subtitle">Processing your login...</p>
        </div>

        <!-- Loading Spinner -->
        <div class="text-center">
          <div class="spinner-border text-primary mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="text-muted">Please wait while we complete your authentication...</p>
        </div>

        <!-- Error Message (hidden by default) -->
        <div id="errorMessage" class="alert alert-danger d-none" role="alert">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <span id="errorText">An error occurred during authentication.</span>
        </div>

        <!-- Success Message (hidden by default) -->
        <div id="successMessage" class="alert alert-success d-none" role="alert">
          <i class="bi bi-check-circle-fill me-2"></i>
          <span id="successText">Authentication successful! Redirecting to dashboard...</span>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS bundle -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <!-- User Manager -->
    <script src="./Scripts/userManager.js"></script>
    
    <!-- OAuth Service -->
    <script src="./Scripts/oauth-service.js"></script>
    
    <!-- Callback Handler -->
    <script>
      // Handle OAuth callback
      document.addEventListener('DOMContentLoaded', function() {
        console.log('OAuth callback page loaded');
        
        // Check if we have OAuth parameters
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        const error = urlParams.get('error');
        
        if (error) {
          console.error('OAuth error:', error);
          showError(`Authentication failed: ${error}`);
          return;
        }
        
        if (!code || !state) {
          console.error('Missing OAuth parameters');
          showError('Invalid authentication parameters. Please try again.');
          return;
        }
        
        // Process the OAuth callback
        if (window.oauthService) {
          window.oauthService.handleCallback().then(userInfo => {
            if (userInfo) {
              console.log('OAuth login successful:', userInfo);
              showSuccess(`Successfully signed in with ${userInfo.provider}!`);
              
              // Create user session
              if (typeof userManager !== 'undefined') {
                const session = userManager.createSocialSession(userInfo);
                if (session) {
                  // Redirect to dashboard after a short delay
                  setTimeout(() => {
                    window.location.href = './dashboard.html';
                  }, 2000);
                } else {
                  showError('Failed to create user session.');
                }
              } else {
                console.error('UserManager not available');
                showError('Authentication service not available.');
              }
            } else {
              showError('Authentication failed. Please try again.');
            }
          }).catch(error => {
            console.error('OAuth callback error:', error);
            showError('Authentication failed. Please try again.');
          });
        } else {
          console.error('OAuth service not available');
          showError('Authentication service not available.');
        }
      });
      
      function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        errorText.textContent = message;
        errorDiv.classList.remove('d-none');
        
        // Hide loading spinner
        document.querySelector('.spinner-border').style.display = 'none';
        document.querySelector('.text-muted').textContent = 'Authentication failed.';
      }
      
      function showSuccess(message) {
        const successDiv = document.getElementById('successMessage');
        const successText = document.getElementById('successText');
        successText.textContent = message;
        successDiv.classList.remove('d-none');
        
        // Hide loading spinner
        document.querySelector('.spinner-border').style.display = 'none';
        document.querySelector('.text-muted').textContent = 'Authentication successful!';
      }
    </script>
  </body>
</html>
